#!/bin/sh
#
# A Zig and ZLS version manager. Downloads the Zig version specified in the
# first argument, along with the respective ZLS release, and activates them by
# creating symlinks in $HOME/.local/bin. Managed versions are placed in
# $XDG_DATA_HOME/zig-swap.
#
# Dependencies:
#   curl
#   minisign (optional, but recommended)

set -e

XDG_DATA_HOME="${XDG_DATA_HOME:-$HOME/.local/share}"
ZIG_SWAP_DIR="$XDG_DATA_HOME/zig-swap"
ZIG_BIN="$HOME/.local/bin/zig"
ZLS_BIN="$HOME/.local/bin/zls"
ZIG_MINISIGN_PUBKEY='RWSGOq2NVecA2UPNdBUZykf1CCb147pkmdtYxgb3Ti+JO/wCYvhbAb/U'
ZLS_MINISIGN_PUBKEY='RWR+9B91GBZ0zOjh6Lr17+zKf5BoSuFvrx2xSeDE57uIYvnKBGmMjOex'
SKIP_SIGNATURE_VERIFICATION=

ARCH="$(uname -m)"
OS="$(uname | tr '[:upper:]' '[:lower:]')"

if [ "$ARCH" = 'arm64' ]; then
	ARCH='aarch64'
fi

if [ "$OS" = 'darwin' ]; then
	OS='macos'
fi

VARIANT_FMT="$ARCH-$OS"
OLD_VARIANT_FMT="$OS-$ARCH"

info() {
	printf '%s\n' "$1" >&2
}

warn() {
	printf 'warning: %s\n' "$1" >&2
}

error() {
	printf 'error: %s\n' "$1" >&2
	exit 1
}

confirm() {
	printf '%s [y/N]: ' "$1" >&2
	read -r _choice
	case "$_choice" in
	[Yy]*) return 0 ;;
	*) return 1 ;;
	esac
}

usage() {
	printf 'usage: %s <ZIG_VERSION>\n' "${0##*/}"
}

valid_version_string() {
	_version_regex='^[0-9]\{1,\}\.[0-9]\{1,\}\.[0-9]\{1,\}$'
	printf '%s\n' "$1" | grep "$_version_regex" >/dev/null 2>&1
}

minor_version() {
	printf '%s' "$1" | cut -f2 -d.
}

supported_version() {
	[ "$(minor_version "$1")" -ge 9 ]
}

latest_zls_patch() {
	_zig_version="$1"
	curl -s 'https://api.github.com/repos/zigtools/zls/releases?per_page=100' |
		grep '"tag_name"' |
		sed 's/.*: "//;s/",*//' |
		grep "^${_zig_version%.*}\." |
		sort -t. -k3 -n |
		tail -1
}

is_empty() {
	for _f in "$1"/*; do
		if [ -e "$_f" ]; then
			return 1
		fi
	done
	return 0
}

on_trap() {
	if [ "$?" -ne 0 ]; then
		[ -d "$CURRENT_ZIG_DIR" ] && is_empty "$CURRENT_ZIG_DIR" && rm -rf "$CURRENT_ZIG_DIR"
		[ -d "$CURRENT_ZLS_DIR" ] && is_empty "$CURRENT_ZLS_DIR" && rm -rf "$CURRENT_ZLS_DIR"
	fi
	[ -d "$TMP_DIR" ] && rm -rf "$TMP_DIR"
}

dl_extract() {
	_url="$1"
	_extract_dir="$2"
	_minisign_pubkey="$3"
	_filename="${_url##*/}"
	_archive="$_extract_dir/$_filename"

	curl -fLo "$_archive" "$_url"

	if [ -z "$SKIP_SIGNATURE_VERIFICATION" ]; then
		info "verifying signature for $_filename"
		curl -sfLo "$_archive".minisig "$_url".minisig
		minisign -qVm "$_archive" -P "$_minisign_pubkey"
		info "signature for $_filename: OK"
	fi

	tar -xf "$_archive" -C "$_extract_dir"
}

download_zig() {
	info "downloading Zig $ZIG_VERSION"

	# use old variant format for Zig < 0.14.1
	_fmt="$VARIANT_FMT"
	if [ "$ZIG_VERSION" = '0.14.0' ] || [ "$(minor_version "$ZIG_VERSION")" -lt 14 ]; then
		_fmt="$OLD_VARIANT_FMT"
	fi

	dl_extract "https://ziglang.org/download/$ZIG_VERSION/zig-$_fmt-$ZIG_VERSION.tar.xz" "$TMP_DIR" "$ZIG_MINISIGN_PUBKEY"

	cp -r "$TMP_DIR/zig-$_fmt-$ZIG_VERSION"/* "$CURRENT_ZIG_DIR"
}

download_zls() {
	info "downloading ZLS $ZLS_VERSION"

	# use old variant format for ZLS < 0.15.0
	_fmt="$VARIANT_FMT"
	if [ "$(minor_version "$ZLS_VERSION")" -lt 15 ]; then
		_fmt="$OLD_VARIANT_FMT"
	fi

	dl_extract "https://builds.zigtools.org/zls-$_fmt-$ZLS_VERSION.tar.xz" "$TMP_DIR" "$ZLS_MINISIGN_PUBKEY"

	cp "$TMP_DIR/zls" "$CURRENT_ZLS_DIR"
}

trap 'on_trap' EXIT

if ! command -v curl >/dev/null 2>&1; then
	error 'missing dependency "curl"'
fi

if [ -z "$1" ]; then
	usage
	exit 1
fi

ZIG_VERSION="$1"

if ! valid_version_string "$ZIG_VERSION"; then
	error 'invalid version provided (format: <major>.<minor>.<patch>)'
fi

if ! supported_version "$ZIG_VERSION"; then
	error "unsupported version: $ZIG_VERSION. ${0##*/} supports Zig 0.9.0+"
fi

if ! command -v minisign >/dev/null 2>&1; then
	warn 'minisign not found'
	if ! confirm 'continue without verifying archive signatures?'; then
		info 'exiting without swapping Zig version'
		exit 0
	fi
	warn 'skipping archive signature verification'
	SKIP_SIGNATURE_VERIFICATION="true"
fi

ZLS_VERSION="$(latest_zls_patch "$ZIG_VERSION")"

CURRENT_ZIG_DIR="$ZIG_SWAP_DIR/zig/$ZIG_VERSION"
mkdir -p "$CURRENT_ZIG_DIR"

CURRENT_ZLS_DIR="$ZIG_SWAP_DIR/zls/$ZLS_VERSION"
mkdir -p "$CURRENT_ZLS_DIR"

TMP_DIR="$(mktemp -d)"
if [ ! -d "$TMP_DIR" ]; then
	error "failed to create temporary directory"
fi

if [ ! -f "$CURRENT_ZIG_DIR/zig" ]; then
	download_zig
fi

if [ ! -f "$CURRENT_ZLS_DIR/zls" ]; then
	download_zls
fi

mkdir -p "$HOME/.local/bin"

if [ -e "$ZIG_BIN" ] && [ ! -L "$ZIG_BIN" ]; then
	error "$ZIG_BIN exists and is not a symlink; refusing to overwrite it"
fi

if [ -e "$ZLS_BIN" ] && [ ! -L "$ZLS_BIN" ]; then
	error "$ZLS_BIN exists and is not a symlink; refusing to overwrite it"
fi

ln -sf "$CURRENT_ZIG_DIR/zig" "$ZIG_BIN"
ln -sf "$CURRENT_ZLS_DIR/zls" "$ZLS_BIN"

info "swapped to Zig $ZIG_VERSION and ZLS $ZLS_VERSION"
